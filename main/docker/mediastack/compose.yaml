networks:
  homelabnetwork:
    external: true

services:
  jellyfin:
    image: lscr.io/linuxserver/jellyfin:latest
    container_name: jellyfin
    # user: ${PUID}:${PGID} # linuxserver containers handle this with environment PUID, PGID
    environment:
      - PUID=0 # ${PUID} # Jellyfin needs root for GPU access
      - PGID=0 # ${PGID} # Jellyfin needs root for GPU access 
      - TZ=${TZ}
      - NVIDIA_DRIVER_CAPABILITIES=all
      - NVIDIA_VISIBLE_DEVICES=all
    networks:
      homelabnetwork:
        ipv4_address: 172.39.0.40
    volumes:
      - ./jellyfin:/config
      - /data:/data
      - /mnt/nas:/mnt/nas
      - /etc/localtime:/etc/localtime:ro
    ports:
      - 8096:8096
      - 7359:7359/udp # Service Discovery
      - 1900:1900/udp # Client Discovery
    runtime: nvidia
    gpus: all
    healthcheck:
      test: curl -s http://localhost:8096 || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: unless-stopped

  seerr:
    image: ghcr.io/seerr-team/seerr:latest
    container_name: seerr    
    user: ${PUID}:${PGID}   
    init: true
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    networks:
      homelabnetwork:
        ipv4_address: 172.39.0.41
    volumes:
      - ./seerr:/app/config
      - /etc/localtime:/etc/localtime:ro
    ports:
      - 5055:5055
    depends_on:
      - jellyfin
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:5055/api/v1/status || exit 1
      timeout: 10
      interval: 30s
      retries: 3
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: unless-stopped

  jellystat-db:
    image: postgres:15.2
    container_name: jellystat-db
    user: ${PUID}:${PGID}   
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ} 
      - POSTGRES_USER=${JELLYSTAT_POSTGRES_USER}
      - POSTGRES_PASSWORD=${JELLYSTAT_POSTGRES_PASSWORD}
    networks:
      homelabnetwork:
        ipv4_address: 172.39.0.42
    volumes:
      - ./jellystat/postgres:/var/lib/postgresql/data
    restart: unless-stopped

  jellystat:
    image: cyfershepard/jellystat:latest
    container_name: jellystat
    user: ${PUID}:${PGID}   
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - POSTGRES_USER=${JELLYSTAT_POSTGRES_USER}
      - POSTGRES_PASSWORD=${JELLYSTAT_POSTGRES_PASSWORD}
      - POSTGRES_IP=jellystat-db
      - POSTGRES_PORT=5432
      - JWT_SECRET=${JELLYSTAT_JWT_SECRET}
    networks:
      homelabnetwork:
        ipv4_address: 172.39.0.43
    volumes:
      - ./jellystat/backup-data:/app/backend/backup-data
      - /etc/localtime:/etc/localtime:ro
    ports:
      - 3000:3000
    depends_on:
      - jellystat-db
    healthcheck:
      test: curl -s http://localhost:3000 || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: unless-stopped
